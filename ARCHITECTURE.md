# Lexi - System Architecture

**Visual representation of the complete system - UOIONHHC**

---

## ğŸ“Š High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERFACE                          â”‚
â”‚                    (Next.js 14 + TypeScript)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ HTTP/REST
                               â”‚ (CORS enabled)
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FASTAPI BACKEND                          â”‚
â”‚                    (Python 3.10+ / Async)                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Documents   â”‚  â”‚  Templates   â”‚  â”‚    Chat      â”‚         â”‚
â”‚  â”‚  /upload     â”‚  â”‚  /match      â”‚  â”‚  /message    â”‚         â”‚
â”‚  â”‚  /extract    â”‚  â”‚  /create     â”‚  â”‚  /vars       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                  â”‚                  â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SERVICE LAYER                               â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Document        â”‚  â”‚ Template        â”‚  â”‚ Gemini         â”‚ â”‚
â”‚  â”‚ Processor       â”‚  â”‚ Service         â”‚  â”‚ Service        â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                â”‚ â”‚
â”‚  â”‚ â€¢ DOCX extract  â”‚  â”‚ â€¢ Extraction    â”‚  â”‚ â€¢ Extraction   â”‚ â”‚
â”‚  â”‚ â€¢ PDF extract   â”‚  â”‚ â€¢ Storage       â”‚  â”‚ â€¢ Matching     â”‚ â”‚
â”‚  â”‚ â€¢ Chunking      â”‚  â”‚ â€¢ Matching      â”‚  â”‚ â€¢ Questions    â”‚ â”‚
â”‚  â”‚ â€¢ Validation    â”‚  â”‚ â€¢ Retrieval     â”‚  â”‚ â€¢ Pre-filling  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ Exa Service     â”‚                    ğŸ BONUS               â”‚
â”‚  â”‚                 â”‚                                           â”‚
â”‚  â”‚ â€¢ Web search    â”‚                                           â”‚
â”‚  â”‚ â€¢ Content fetch â”‚                                           â”‚
â”‚  â”‚ â€¢ Discovery     â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                    â”‚
          â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DATABASE (SQLite)  â”‚          â”‚    EXTERNAL SERVICES          â”‚
â”‚                      â”‚          â”‚                               â”‚
â”‚  â€¢ templates         â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â€¢ variables         â”‚          â”‚  â”‚ Gemini API             â”‚  â”‚
â”‚  â€¢ instances         â”‚          â”‚  â”‚ (Google AI Studio)     â”‚  â”‚
â”‚  â€¢ documents         â”‚          â”‚  â”‚                        â”‚  â”‚
â”‚  â€¢ embeddings        â”‚          â”‚  â”‚ â€¢ Variable extraction  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚ â€¢ Template matching    â”‚  â”‚
                                  â”‚  â”‚ â€¢ Question generation  â”‚  â”‚
                                  â”‚  â”‚ â€¢ Embeddings           â”‚  â”‚
                                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                  â”‚                               â”‚
                                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                  â”‚  â”‚ Exa.ai API  ğŸ         â”‚  â”‚
                                  â”‚  â”‚                        â”‚  â”‚
                                  â”‚  â”‚ â€¢ Web search           â”‚  â”‚
                                  â”‚  â”‚ â€¢ Content extraction   â”‚  â”‚
                                  â”‚  â”‚ â€¢ Template discovery   â”‚  â”‚
                                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow Diagrams

### Flow 1: Document Upload â†’ Template Creation

```
USER
  â”‚
  â”‚ 1. Upload DOCX/PDF
  â–¼
[Upload Dialog]
  â”‚
  â”‚ 2. Validate file
  â–¼
[Document Processor]
  â”‚
  â”œâ”€â†’ Extract text from DOCX/PDF
  â”‚
  â”‚ 3. Text extracted
  â–¼
[Gemini Service]
  â”‚
  â”œâ”€â†’ 4a. Split into chunks (if large)
  â”‚
  â”œâ”€â†’ 4b. Process chunk 1
  â”‚   â””â”€â†’ Extract variables (JSON)
  â”‚
  â”œâ”€â†’ 4c. Process chunk 2-N
  â”‚   â””â”€â†’ Reuse existing vars + add new
  â”‚
  â”‚ 5. Merge & deduplicate
  â–¼
[Template Service]
  â”‚
  â”œâ”€â†’ Replace spans with {{variables}}
  â”œâ”€â†’ Generate embedding
  â”œâ”€â†’ Create YAML front-matter
  â”‚
  â”‚ 6. Save to database
  â–¼
[Database]
  â”‚
  â”œâ”€â†’ Insert template record
  â”œâ”€â†’ Insert variable records
  â”‚
  â”‚ 7. Return template_id
  â–¼
USER
  â””â”€â†’ "Template saved! ID: tpl_abc123"
```

### Flow 2: Chat-Based Drafting

```
USER: "Draft a notice to insurer"
  â”‚
  â–¼
[Chat API]
  â”‚
  â”‚ 1. Parse request
  â–¼
[Template Service]
  â”‚
  â”œâ”€â†’ Get all templates from DB
  â”‚
  â”‚ 2. Match request to templates
  â–¼
[Gemini Service]
  â”‚
  â”œâ”€â†’ Classification prompt
  â”œâ”€â†’ Calculate similarity
  â”‚
  â”‚ 3. Return best match + alternatives
  â–¼
[Chat API]
  â”‚
  â””â”€â†’ USER: "Match found: Insurance Notice (87%)"
      USER: "yes"
  â”‚
  â”‚ 4. Pre-fill variables from query
  â–¼
[Gemini Service]
  â”‚
  â”œâ”€â†’ Extract mentions from query
  â”‚
  â”‚ 5. Generate questions for remaining vars
  â–¼
[Gemini Service]
  â”‚
  â”œâ”€â†’ Transform to human-friendly questions
  â”‚
  â”‚ 6. Ask questions iteratively
  â–¼
USER: Provides answers
  â”‚
  â”‚ 7. Store answers in instance
  â–¼
[Database: instances table]
  â”‚
  â”‚ 8. All answered â†’ Generate draft
  â–¼
[Template Service]
  â”‚
  â”œâ”€â†’ Load template body
  â”œâ”€â†’ Replace {{variable}} with answers
  â”‚
  â”‚ 9. Return draft markdown
  â–¼
USER: Copy / Download / Regenerate
```

### Flow 3: Web Bootstrap (Bonus)

```
USER: "Draft a lease deed for Victoria"
  â”‚
  â–¼
[Template Service]
  â”‚
  â”œâ”€â†’ Query DB for matches
  â”‚
  â”‚ No local match found
  â–¼
[Chat API]
  â”‚
  â”‚ Check if Exa.ai enabled
  â–¼
[Exa Service] ğŸ
  â”‚
  â”œâ”€â†’ 1. Build search query
  â”‚   â””â”€â†’ "lease deed victoria australia legal template"
  â”‚
  â”‚ 2. Search web via Exa.ai
  â–¼
[Exa.ai API]
  â”‚
  â”œâ”€â†’ Find 5 relevant documents
  â”‚
  â”‚ 3. Return results with content
  â–¼
[Chat API]
  â”‚
  â””â”€â†’ USER: "Found 3 similar documents online"
      USER: Selects result #1
  â”‚
  â”‚ 4. Extract template from web doc
  â–¼
[Template Service]
  â”‚
  â”œâ”€â†’ Process web content like uploaded doc
  â”œâ”€â†’ Extract variables with Gemini
  â”œâ”€â†’ Save as new template
  â”‚
  â”‚ 5. Template created
  â–¼
[Normal Drafting Flow]
  â””â”€â†’ Continue with Q&A...
```

---

## ğŸ§© Component Interaction Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚ Document â”‚ Template â”‚  Gemini  â”‚   Exa    â”‚
â”‚                 â”‚  Proc.   â”‚ Service  â”‚ Service  â”‚ Service  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Upload Dialog   â”‚    âœ“     â”‚    âœ“     â”‚          â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Chat Interface  â”‚          â”‚    âœ“     â”‚    âœ“     â”‚    âœ“     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Template List   â”‚          â”‚    âœ“     â”‚          â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Doc Processor   â”‚    -     â”‚          â”‚    âœ“     â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Template Svc    â”‚    âœ“     â”‚    -     â”‚    âœ“     â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Gemini Service  â”‚          â”‚          â”‚    -     â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Exa Service     â”‚          â”‚    âœ“     â”‚    âœ“     â”‚    -     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ“ = Direct dependency
```

---

## ğŸ—„ï¸ Database Entity-Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     templates        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id               â”‚â”€â”€â”€â”
â”‚     title            â”‚   â”‚
â”‚     description      â”‚   â”‚
â”‚     doc_type         â”‚   â”‚
â”‚     jurisdiction     â”‚   â”‚
â”‚     similarity_tags  â”‚   â”‚ 1:N
â”‚     body_md          â”‚   â”‚
â”‚     embedding        â”‚   â”‚
â”‚     created_at       â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                           â”‚
                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   template_variables     â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚ PK  id                   â”‚
            â”‚ FK  template_id          â”‚
            â”‚     key                  â”‚
            â”‚     label                â”‚
            â”‚     description          â”‚
            â”‚     example              â”‚
            â”‚     required             â”‚
            â”‚     dtype                â”‚
            â”‚     regex                â”‚
            â”‚     enum_values          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      instances       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id               â”‚
â”‚ FK  template_id      â”‚â”€â”€â”€â†’ templates.id
â”‚     user_query       â”‚
â”‚     answers_json     â”‚
â”‚     draft_md         â”‚
â”‚     created_at       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      documents       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id               â”‚
â”‚     filename         â”‚
â”‚     mime_type        â”‚
â”‚     raw_text         â”‚
â”‚     embedding        â”‚
â”‚     created_at       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Smart Prompting Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   VARIABLE EXTRACTION                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Input: Document text chunk + Existing variables (if any)
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gemini Prompt Engineering           â”‚
â”‚                                      â”‚
â”‚  System Prompt:                      â”‚
â”‚  â€¢ You are a legal templating expertâ”‚
â”‚  â€¢ Extract reusable variables       â”‚
â”‚  â€¢ Deduplicate logically            â”‚
â”‚  â€¢ Use snake_case keys              â”‚
â”‚  â€¢ Return strict JSON               â”‚
â”‚                                      â”‚
â”‚  User Prompt:                        â”‚
â”‚  â€¢ Document text: {chunk}           â”‚
â”‚  â€¢ Existing vars: {variables}       â”‚
â”‚  â€¢ Reuse keys where meaning matches â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼ Temperature: 0.3
   â–¼ Max tokens: 8192
   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gemini API Response                 â”‚
â”‚                                      â”‚
â”‚  {                                   â”‚
â”‚    "variables": [                   â”‚
â”‚      {                              â”‚
â”‚        "key": "claimant_name",      â”‚
â”‚        "label": "Claimant's Name",  â”‚
â”‚        "description": "...",        â”‚
â”‚        "example": "John Doe",       â”‚
â”‚        "required": true,            â”‚
â”‚        "dtype": "string"            â”‚
â”‚      }                              â”‚
â”‚    ],                               â”‚
â”‚    "similarity_tags": [...]         â”‚
â”‚  }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
Output: Structured variables + tags

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TEMPLATE MATCHING                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Input: User query + Available templates
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gemini Classification Prompt        â”‚
â”‚                                      â”‚
â”‚  System Prompt:                      â”‚
â”‚  â€¢ Match user request to templates  â”‚
â”‚  â€¢ Use doc type, jurisdiction, etc  â”‚
â”‚  â€¢ Score confidence 0-1             â”‚
â”‚  â€¢ Return best + alternatives       â”‚
â”‚  â€¢ Reject if confidence < 0.6       â”‚
â”‚                                      â”‚
â”‚  User Prompt:                        â”‚
â”‚  â€¢ Request: {user_query}            â”‚
â”‚  â€¢ Templates: [{metadata}...]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼ Temperature: 0.2
   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gemini API Response                 â”‚
â”‚                                      â”‚
â”‚  {                                   â”‚
â”‚    "best_match": {                  â”‚
â”‚      "template_id": "tpl_123",      â”‚
â”‚      "confidence": 0.87,            â”‚
â”‚      "justification": "..."         â”‚
â”‚    },                               â”‚
â”‚    "alternatives": [...]            â”‚
â”‚  }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
Output: Match result with confidence

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  QUESTION GENERATION                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Input: Variable definitions
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gemini Question Transform Prompt    â”‚
â”‚                                      â”‚
â”‚  System Prompt:                      â”‚
â”‚  â€¢ Convert to user-friendly questionsâ”‚
â”‚  â€¢ Add context and format hints     â”‚
â”‚  â€¢ No technical jargon              â”‚
â”‚  â€¢ Professional language            â”‚
â”‚                                      â”‚
â”‚  Examples:                           â”‚
â”‚  â€¢ Bad: "policy_number?"            â”‚
â”‚  â€¢ Good: "What is the insurance     â”‚
â”‚    policy number as it appears      â”‚
â”‚    on your schedule?"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼ Temperature: 0.4
   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gemini API Response                 â”‚
â”‚                                      â”‚
â”‚  [                                   â”‚
â”‚    {                                â”‚
â”‚      "variable_key": "policy_num",  â”‚
â”‚      "question": "What is the...",  â”‚
â”‚      "hint": "Format: POL-XXXXXX",  â”‚
â”‚      "required": true               â”‚
â”‚    }                                â”‚
â”‚  ]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
Output: User-friendly questions
```

---

## ğŸ” Security & Validation Flow

```
User Input
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Validation â”‚
â”‚ â€¢ Required fields   â”‚
â”‚ â€¢ Basic types       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Validation      â”‚
â”‚ â€¢ Pydantic schemas  â”‚
â”‚ â€¢ Type checking     â”‚
â”‚ â€¢ Size limits       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Business Logic      â”‚
â”‚ â€¢ File type         â”‚
â”‚ â€¢ Regex patterns    â”‚
â”‚ â€¢ ISO dates         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database            â”‚
â”‚ â€¢ Constraints       â”‚
â”‚ â€¢ Foreign keys      â”‚
â”‚ â€¢ NOT NULL          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
Validated Data âœ“
```

---

**Architecture designed by UOIONHHC** ğŸ—ï¸

*Clean, scalable, and production-ready*
